<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - NOTHING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #0b071d;
      --color: #6343da;
      --bg02: #0d052a;
      --text-light: #ddd;
      --text-muted: #aaa;
      --btn-bg: #6343da;
      --btn-hover: #7d59ff;
      --success: #00e676;
      --error: #ff3b3b;
      --warning: #ffc107;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    header h1 {
      color: var(--color);
    }
    button#logoutBtn {
      background: var(--btn-bg);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    button#logoutBtn:hover {
      background: var(--btn-hover);
    }
    .user-info {
      margin-bottom: 30px;
      background: var(--bg02);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px var(--color);
    }
    .user-info h2 {
      margin-bottom: 15px;
      color: var(--color);
    }
    .user-info p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    .apps-section {
      margin-bottom: 40px;
      background: var(--bg02);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px var(--color);
    }
    .apps-section h3 {
      color: var(--color);
      margin-bottom: 10px;
    }
    .apps-list {
      list-style: none;
      padding-left: 0;
    }
    .apps-list li {
      background: #1a1460;
      margin-bottom: 8px;
      padding: 10px 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      cursor: default;
    }
    .apps-list li span.app-name {
      color: #90caf9;
    }
    .apps-list li button.delete-btn {
      background: var(--error);
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    .apps-list li button.delete-btn:hover {
      background: #ff5555;
    }
    .deploy-section {
      background: var(--bg02);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px var(--color);
      max-width: 400px;
    }
    .deploy-section h3 {
      color: var(--color);
      margin-bottom: 15px;
    }
    .deploy-section form {
      display: flex;
      flex-direction: column;
    }
    .deploy-section input {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    .deploy-section button {
      padding: 12px;
      border-radius: 30px;
      border: none;
      background: var(--btn-bg);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .deploy-section button:hover {
      background: var(--btn-hover);
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
    #status.success {
      color: var(--success);
    }
    #status.error {
      color: var(--error);
    }
  </style>
</head>
<body>

<header>
  <h1>Dashboard</h1>
  <button id="logoutBtn">Logout</button>
</header>

<section class="user-info">
  <h2>User Info</h2>
  <p><strong>Username:</strong> <span id="username"></span></p>
  <p><strong>Email:</strong> <span id="email"></span></p>
  <p><strong>Phone:</strong> <span id="phone"></span></p>
</section>

<section class="apps-section">
  <h3>Total Bots: <span id="totalBots">0</span></h3>
  <ul class="apps-list" id="appsList"></ul>
</section>

<section class="deploy-section">
  <h3>Deploy New Bot</h3>
  <form id="deployForm">
    <input type="text" id="sessionId" placeholder="Session ID (Required)" required />
    <input type="text" id="appName" placeholder="App Name (optional)" />
    <button type="submit">Deploy Bot</button>
  </form>
  <div id="status"></div>
</section>

<script>
  // چک کردن یوزر لاگین شده
  const username = localStorage.getItem('username');

  if (!username) {
    // اگر لاگین نیست، برگرد به صفحه لاگین
    window.location.href = '/login';
  } else {
    // بارگذاری مشخصات کاربر و اپ‌ها از سرور (یا localStorage)
    fetchUserData();
  }

  async function fetchUserData() {
    try {
      // اطلاعات کاربر رو از گیت هاب بگیر
      const res = await fetch(`https://raw.githubusercontent.com/apis-endpoint/Number3/main/deploy/${username}.json`);
      if (!res.ok) throw new Error('User data not found');
      const userData = await res.json();

      document.getElementById('username').textContent = userData.username || '';
      document.getElementById('email').textContent = userData.email || '';
      document.getElementById('phone').textContent = userData.phone || '';

      const appsList = document.getElementById('appsList');
      appsList.innerHTML = '';

      if (Array.isArray(userData.apps) && userData.apps.length > 0) {
        document.getElementById('totalBots').textContent = userData.apps.length;
        userData.apps.forEach(appName => {
          const li = document.createElement('li');

          const span = document.createElement('span');
          span.textContent = appName;
          span.className = 'app-name';

          // دکمه حذف (Delete)
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.className = 'delete-btn';
          delBtn.onclick = () => deleteApp(appName);

          li.appendChild(span);
          li.appendChild(delBtn);
          appsList.appendChild(li);
        });
      } else {
        document.getElementById('totalBots').textContent = 0;
        appsList.innerHTML = '<li style="color: var(--text-muted);">No bots deployed yet.</li>';
      }
    } catch (error) {
      console.error(error);
      Swal.fire('Error', 'Failed to load user data. Please try again.', 'error');
    }
  }

  // حذف اپ (این بخش نیاز به API سمت سرور داره، اگر داری بگو اضافه کنم)
  async function deleteApp(appName) {
    const confirmDel = await Swal.fire({
      title: `Delete ${appName}?`,
      text: "Are you sure you want to delete this bot?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it',
      cancelButtonText: 'Cancel'
    });
    if (!confirmDel.isConfirmed) return;

    try {
      // درخواست حذف به سرور (فرض بر این است API وجود دارد)
      const res = await fetch(`/api/deleteapp/${appName}?username=${encodeURIComponent(username)}`, { method: 'DELETE' });

      Swal.fire('Deleted!', `${appName} has been deleted.`, 'success');

      // بعد از حذف، داده‌ها را دوباره بگیر
      fetchUserData();
    } catch (error) {
      Swal.fire('Error', 'Failed to delete the app.', 'error');
    }
  }

  // لاگ‌اوت
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('username');
    window.location.href = '/login';
  });

  // فرم دیپلوی
  const deployForm = document.getElementById('deployForm');
  const statusEl = document.getElementById('status');

  deployForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const sessionId = document.getElementById('sessionId').value.trim();
    const appName = document.getElementById('appName').value.trim();

    statusEl.textContent = 'Deploying...';
    statusEl.className = '';

    if (!sessionId) {
      statusEl.textContent = 'SESSION_ID is required.';
      statusEl.classList.add('error');
      return;
    }

    try {
      const res = await fetch('/deploy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId, appName, username })
      });

      const data = await res.json();

      if (res.ok) {
        statusEl.innerHTML = `✅ Deployment started: <a href="${data.appUrl}" target="_blank">${data.appUrl}</a>`;
        statusEl.classList.add('success');
        deployForm.reset();

        // بروزرسانی اطلاعات کاربر بعد از دیپلوی جدید
        fetchUserData();
      } else {
        statusEl.textContent = data.error || 'Deployment failed.';
        statusEl.classList.add('error');
      }
    } catch (err) {
      statusEl.textContent = 'Error: ' + err.message;
      statusEl.classList.add('error');
    }
  });
</script>

</body>
</html>